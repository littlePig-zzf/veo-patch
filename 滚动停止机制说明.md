# 滚动停止机制说明

脚本现在有 **5 层保护机制**，确保滚动不会无限循环：

## 1️⃣ 最大尝试次数限制
```python
max_attempts = 200
```
- **触发条件**：滚动尝试超过 200 次
- **作用**：防止极端情况下的无限循环
- **适用场景**：任何异常情况

## 2️⃣ 连续无进展检测 ⭐ 新增
```python
no_progress_count > 10
```
- **触发条件**：连续 10 次滚动都没有收集到新视频
- **作用**：检测视频是否已经全部加载/不存在
- **适用场景**：请求的视频索引不存在（如只有 50 个视频，却请求 1-230）

**示例输出：**
```
⚠️ 无新收集 1/10 次
⚠️ 无新收集 2/10 次
...
⚠️ 无新收集 10/10 次
❌ 连续 10 次无进展，停止滚动
```

## 3️⃣ 滚动位置卡住检测
```python
stuck_count > 5
```
- **触发条件**：连续 5 次滚动，`scrollTop` 位置没有变化
- **作用**：检测是否已到达页面顶部或底部
- **适用场景**：滚动到边界，无法继续滚动

**示例输出：**
```
⚠️ 滚动位置未变 1/5
⚠️ 滚动位置未变 2/5
...
❌ 滚动已到达边界（顶部或底部）
```

## 4️⃣ 成功收集完成
```python
len(self.collected_videos) >= total_needed
```
- **触发条件**：收集到所有目标视频
- **作用**：正常完成收集
- **适用场景**：一切顺利

**示例输出：**
```
✅ 所有视频已收集完毕
```

## 5️⃣ 用户确认机制 ⭐ 新增
```python
if len(self.collected_videos) < total_needed:
    user_input = input("是否继续下载这些视频? (y/n): ")
```
- **触发条件**：收集到的视频数量少于目标数量
- **作用**：让用户决定是否继续下载部分视频
- **特殊保护**：如果一个视频都没收集到，直接报错退出

**示例输出：**
```
⚠️ 只收集到 45/230 个视频
缺失索引: 46, 47, 48, ..., 230

只找到 45 个视频，是否继续下载这些视频? (y/n):
```

---

## 典型场景分析

### 场景 1: 请求的视频不存在
```
用户输入: 起始 1, 结束 230
实际存在: 只有 50 个视频
```

**执行流程：**
1. 滚动并收集到索引 1-50 的视频
2. 继续滚动寻找 51-230，但页面没有更多视频
3. **触发机制 2**：连续 10 次无新收集 → 停止滚动
4. **触发机制 5**：询问用户是否下载已收集的 50 个视频

### 场景 2: 滚动到底部
```
用户输入: 起始 1, 结束 100
实际情况: 滚动到底部，只收集到 80 个
```

**执行流程：**
1. 滚动到底部
2. **触发机制 3**：连续 5 次 scrollTop 未变 → 已到达底部
3. **触发机制 5**：询问用户是否下载已收集的 80 个视频

### 场景 3: 页面异常，一个都没加载
```
用户输入: 起始 1, 结束 10
实际情况: 页面出错，没有视频
```

**执行流程：**
1. 滚动但无法收集到任何视频
2. **触发机制 2**：连续 10 次无进展
3. **触发机制 5**：检测到 0 个视频 → 直接抛出异常退出

---

## 建议配置

### 保守配置（避免误判）
```python
max_attempts = 300           # 更多尝试次数
no_progress_count > 15       # 更宽容
stuck_count > 8              # 更宽容
```

### 激进配置（快速失败）
```python
max_attempts = 100           # 更少尝试次数
no_progress_count > 5        # 更严格
stuck_count > 3              # 更严格
```

当前使用的是**平衡配置**，适合大多数场景。
